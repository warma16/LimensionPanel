#!/usr/bin/env node

import {generate} from "ts-to-zod";
// @ts-ignore
import fs from "fs";
// @ts-ignore
import path from "path";
import {fileURLToPath} from "url";

// @ts-ignore
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const projectRoot = path.resolve(__dirname, "../../app/");
const inputDir = path.join(projectRoot, "types");
const outputDir = path.join(projectRoot, "types/zod-schemas");

fs.mkdirSync(outputDir, {recursive: true});

// èŽ·å–æ‰€æœ‰éœ€è¦è½¬æ¢çš„.tsæ–‡ä»¶ï¼ˆæŽ’é™¤.d.tsï¼‰
const tsFiles = fs
    .readdirSync(inputDir)
    .filter((file) => file.endsWith(".ts") && !file.endsWith(".d.ts"));

// å¤„ç†æ¯ä¸ªæ–‡ä»¶
tsFiles.forEach((file) => {
    const inputPath = path.join(inputDir, file);
    const outputPath = path.join(outputDir, file);

    // è¯»å–æºæ–‡ä»¶å†…å®¹
    const sourceText = fs.readFileSync(inputPath, "utf8");

    // ç”Ÿæˆ Zod æ¨¡å¼ä»£ç 
    const {getZodSchemasFile, errors} = generate({
        sourceText,
        keepComments: true, // ä¿ç•™æ³¨é‡Š
    });

    if (errors.length > 0) {
        console.error(`âœ— Error processing ${file}:`, errors);
    }

    // å†™å…¥è¾“å‡ºæ–‡ä»¶
    fs.writeFileSync(outputPath, getZodSchemasFile(inputPath));
    console.log(`âœ“ Generated ${path.relative(__dirname, outputPath)}`);

});

console.log("ðŸŽ‰ Zod schema generation completed!");
